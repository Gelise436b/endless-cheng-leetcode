## 📝 单题精研笔记：[2090] 半径为 k 的子数组平均值  

> **题型定位**：定长滑动窗口（变体）｜**难度**：Medium｜**核心范式**：三步法（进入 → 更新 → 退出）

---

### 🔍 问题本质  
给定数组 `nums` 和半径 `k`，对每个下标 `i`，若存在以 `i` 为中心、左右各延伸 `k` 个元素的子数组（即区间 `[i−k, i+k]`），则计算其**向下取整的平均值**；否则填 `-1`。  
- **窗口长度固定为** `L = 2k + 1`  
- **有效中心范围**：`i ∈ [k, n−k−1]`  
- **关键转化**：将“中心视角”转为“右边界驱动”——当右端点 `i = 2k` 时，首个完整窗口 `[0, 2k]` 形成，其中心恰为 `k`

---

### 🧠 解题思路：三步法的优雅变奏  
尽管题目描述围绕“中心”，但代码以**右端点 `i` 为循环变量**，自然导出窗口维护逻辑：

| 步骤 | 操作 | 说明 |
|------|------|------|
| **1. 进入** | `s += nums[i]` | 无条件纳入当前右端点元素 |
| **2. 更新** | `if (i >= 2k) avgs[i - k] = s / (2k+1)` | 当 `i ≥ 2k` 时，窗口首次满长（含 `2k+1` 元素），中心为 `i−k` |
| **3. 退出** | `s -= nums[i - 2k]` | 移出窗口最左元素（索引 `i−2k`），为下一轮保持窗口长度 |

> ✅ **为何是 `i - 2k`？**  
> 当前窗口为 `[i−2k, i]`（长度 `2k+1`），左端点即 `i−2k`，移出后下一窗口为 `[i−2k+1, i+1]`

---

### ⚠️ 易错点与防御性设计  
1. **窗口长度误判**  
   - ❌ 错误：将长度当作 `k` 或 `2k`  
   - ✅ 正确：半径 `k` ⇒ 总长 `2k + 1`（含中心）

2. **整数溢出**  
   - ❌ 错误：用 `int sum` 累加  
   - ✅ 正确：声明 `long long s` 防溢出

3. **越界访问**  
   - ❌ 错误：在 `i < 2k` 时执行 `s -= nums[i - 2k]`（负下标）  
   - ✅ 正确：“退出”操作仅在窗口满后执行（即更新答案之后）

4. **除法精度**  
   - ✅ 题目要求向下取整，`long long` 除以 `int` 自动截断，符合要求

---

### 📐 核心关系推导  
| 概念 | 表达式 | 说明 |
|------|--------|------|
| 窗口长度 | `L = 2k + 1` | 由半径定义决定 |
| 首个有效右端点 | `i = L - 1 = 2k` | 此时窗口 `[0, 2k]` 首次满长 |
| 当前窗口中心 | `c = i - k` | 因窗口 `[i−2k, i]` 中点为 `(i−2k + i)/2 = i−k` |
| 左端点索引 | `left = i - 2k` | 窗口起始位置 |

---

### 💡 范式提炼：定长窗口通用模板（右边界驱动）
```cpp
vector<int> ans(n, default_val);
long long window_sum = 0;
int L = /* 目标窗口长度 */;

for (int i = 0; i < n; ++i) {
    // 1. 进入：纳入右端
    window_sum += nums[i];
    
    // 2. 更新：窗口满时处理答案
    if (i >= L - 1) {
        ans[/* 映射位置 */] = window_sum / L; // 或其他逻辑
        // 3. 退出：移出左端
        window_sum -= nums[i - L + 1];
    }
}
```
> 在本题中：`L = 2k+1`，映射位置为 `i - k`，左端索引 `i - L + 1 = i - 2k`

---

### ✅ 复杂度分析  
- **时间复杂度**：O(n)，单次遍历  
- **空间复杂度**：O(1)（不计输出数组）

---

### 📌 总结  
[2090] 是**定长滑动窗口的经典变体**，其精妙之处在于：  
- 将“中心对称”问题转化为“右边界触发”的线性过程；  
- 完美诠释三步法的普适性——**无论问题如何包装，只要窗口长度固定，皆可套用“进→更→退”流程**；  
- 强化了对**索引映射关系**的敏感度：窗口几何属性（如中心、半径）终将落脚于数组下标的代数表达。  

> 此题掌握后，所有定长窗口问题（如最大平均、满足阈值计数、最小涂色等）均可视为同一范式的不同实例。
